@page "{handler?}"
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model PPT.Pages.DoctorAttendanceModel
@{
	ViewData["Title"] = "حضور الدكتور";
}


@*strategy: 1: select doctor      DONE
			2: select month
			3: view fresh table of this month regardless of old attendance
			4: new checked days will be added 
			take into consideration that this page will not allow updates,
			so an update is as follows: 
			1: select a doctor and a specific month, and then only show days 
			with attendance done, to allow the clerk to remove them(delete rows 
			from the database), so there is no update but only delete, unless the
			doctor is contracted, so we will show field to update duration
			if attendance is still checked, if unchecked -> hide duration update field.
*@
<body>
	

        <select id="ddlDoctors" name="id" style="width:170px;" asp-items="@Model.DoctorsList">
            <option value="0">الإسم</option>
        </select>
@*        <input type="hidden" name="DrName"/>*@
        <br/>
        <br/>
@*        <input type="submit" value="Submit"asp-page-handler="Search"/>*@
		<script src="~/lib/jquery/dist/jquery.min.js"></script>
		<link href="~/lib/select2/dist/css/select2.min.css" rel="stylesheet" />
		<script src="~/lib/select2/dist/js/select2.min.js" defer></script>
        <script type="text/javascript">
            $(function () {
				$("#ddlDoctors").select2();
				$('#ddlDoctors').on('select2:selecting', function(e) {
					$.ajax({
					url: "/doctorattendance/iscontracted",
					data: { "id": e.params.args.data.id },
					success: function (result) {
						if (result == "true")
							$("#duration").show();
						else 
							$("#duration").hide();
					}
					});
					$("#tableBody").find("tr:not(:first)").remove();
				});
            });
        </script>


@*	<form>
		<p>
			الإسم: <input type="text" asp-for="SearchString" />
			<input type="submit" value="بحث" asp-page-handler="Search"/>
		</p>
	</form>
	@{
		if(@Model.Doctors != null)
		{
			<ul>@foreach(var doctor in @Model.Doctors)
			{
				<li>@doctor.name</li>
			}			
			</ul>
		}
			
	}*@


	
@*	<script>
		function show()
		{
			const day = document.getElementById("day");
			const month = document.getElementById("month");
			if(day.checked)
			{
				document.getElementById("dayselector").style.display = "block";
				document.getElementById("monthselector").style.display = "none";
			}
			if(month.checked)
			{
				document.getElementById("monthselector").style.display = "block";
				document.getElementById("dayselector").style.display = "none";
			}
		}
		
	</script>*@

@*	<input type="radio" id="day" name="attendaceType" value="DAY" onclick="show()">
	<label for="day">يومي</label><br />

	<input type="radio" id="month" name="attendaceType" value="MONTH" onclick="show()">
	<label for="month">شهري</label><br /><br />*@
	

	<div id="monthselector"> 
		<label for="monthSel">الشهر</label>
		<input type="month" id="monthSel" name="month" onchange="showTable()">
		<br /><br />
		<form>

			<table id="tableBody">
				<tr id ="table_head">
					<th>اليوم</th>
					<th>الحضور</th>
					<th id = "duration" style="display:none">المدة</th>
			    </tr>

			</table>
			<script>
					//document.getElementById('ddlDoctors').addEventListener("change", () => {
					//	Console.Log("hi");
					//	var url = `/IsContracted?id=${document.getElementById('ddlDoctors').selectedOptions[0].value}`;
					//	fetch(url)
					//		.then((response) => {
					//			return response.text();
					//		})
					//		.then((result) => {
					//			if(result=="true")
					//				document.getElementById("duration").style.display = "block";
					//		});
					//});

				function showTable() {
					var date = document.getElementById('monthSel').value;
                    if (date != NaN && document.getElementById('ddlDoctors').value !=0) {
                        const data = date.split("-");
                        var year = parseInt(data[0]);
                        var month = parseInt(data[1]);
                        var days = new Date(year, month, 0).getDate();
                        var table = document.getElementById('tableBody');
						for(let i = 1;i < table.children.length;)
							table.removeChild(table.children[i]);
                        for (let i = 1; i < days; i++) {
                            let current_day = new Date(year, month, i);
							let row = document.createElement('tr');

							let c1 = document.createElement('td');
							let c2 = document.createElement('td');

							c1.innerHTML  = current_day.toLocaleDateString();
                            var x = document.createElement('INPUT');
							x.setAttribute("type", "checkbox");
							x.setAttribute("name", "AreChecked");
							x.setAttribute("id",current_day.toLocaleDateString());
							x.setAttribute("value",current_day.toLocaleDateString())
							x.addEventListener('change', function() {
								let aid = "duration"+this.id;
								let a = document.getElementById(aid);
								if (this.checked) {
									a.disabled = false;
									
								} else {
									a.disabled = true;
								}
							});
							c2.appendChild(x);
                            row.appendChild(c1);
							row.appendChild(c2);
							if (window.getComputedStyle(document.getElementById('duration')).display != 'none') {
								let c3 = document.createElement("td")
								let y = document.createElement('INPUT');
								y.setAttribute("type", "number");
								y.setAttribute("name","durations");
								y.disabled = true;
								y.setAttribute("id","duration"+ current_day.toLocaleDateString());
								y.style.width = "70px";
								c3.appendChild(y);
								row.appendChild(c3);
                            }
								
                            table.appendChild(row)
                        }
                    }
				}
				
			</script>

			<input type="submit" value="حفظ" asp-page-handler="DateAttendance"/>
		</form>		
	</div>

@*	<div id="dayselector" style="display:none">
		<form>
			<label for="day">اليوم</label>
			<input type="date" id="daySel" name="day" ><br /><br />
			<label for="attendance">الحضور</label>
			<input type="checkbox" id="attendance" name="IsChecked" value="true"><br />
			<input type="submit" value="حفظ" asp-page-handler="ByDay"/>
		</form>
	</div>*@

</body>
